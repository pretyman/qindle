#summary 简要介绍kindle dx所用的消息队列与任务管理方法

= Introduction =

Kindle DX使用java作为应用软件平台。java平台的主要优势在于平台无关性，但由此也带来了一定缺陷：无论是进程间通信还是进程管理，都没有太好的方法，因此有必要提供一个中间层来处理这些问题。


= Kindle DX的消息队列 =

Kindle DX的java平台通过jni提供了dbus的绑定。但Kindle系统中包含大量shell脚本和底层程序，不适合直接使用dbus，所以用了一个名叫lipc的消息系统作为包装。
lipc包括一系列的以lipc开头的程序：

 * lipc-daemon 守护进程，详见下文
 * lipc-get-prop
 * lipc-set-prop 读写属性值的程序
 * lipc-send-event
 * lipc-wait-event 发送/接收事件的程序
 
以上程序都是调用liblipc.so完成实际工作。liblipc.so再通过glib binding访问dbus

lipc对外采用纯文本接口，格式如下：
{{{
<family name> <property> <value>
<family name> <event>
}}}

lipc反映在dbus上是method和signal两种消息，分别对应上述property和event，具体格式如下：
{{{
# dbus-send --system --type=method_call --print-reply --dest=com.lab126.audio /default com.lab126.setURIStr string:"file:///mnt/us"
method return sender=:1.14 -> dest=:1.90
   uint32 0

#dbus-send --system --type=method_call --print-reply --dest=com.lab126.audio /default com.lab126.getURIStr                         
method return sender=:1.14 -> dest=:1.91
   uint32 0
   string "file:///mnt/us"

其中最后部分的组成规律是[get|set][property name][Str|Int]
返回值为0表示成功，2表示语法错误，8表示无此属性（最可能原因是变量类型错误)

signal sender=:1.2 -> dest=(null destination) path=/default; interface=com.lab126.powerd; member=goingToScreenSaver

signal sender=:1.2 -> dest=(null destination) path=/default; interface=com.lab126.powerd; member=outOfScreenSaver
   int32 1

其中部分事件带返回值。

}}}

其中com.lab126.audio Control属性：
|| 1 || 播放 ||
|| 2 || 暂停 ||
|| 3 || 停止 ||
|| 4 || 程序正在执行（只读） ||

lipc-daemon并不负责消息传递，而是提供服务：

 * 将/proc中的部分内容映射到lipc
 * 使用脚本处理简单事件

另外一套_疑似_消息传递系统是tphserver。相关代码在内核态和用户态都存在，_推测_是用于传递内核事件。

= Kindle DX的任务管理 =

如前所述，kindle的任务管理主要是通过pmond程序进行的。
pmond监听lipc的消息，并根据需要调用或终止程序（相关配置已事先写在配置文件里）
pmond的主要功能是：

 * 防止内存泄漏
 * 当程序失去响应时重新启动

第二项是通过watchdogd程序作用。当失去响应或内存占用超过设定值时，_推测_通过retryd程序重新启动目标程序。